<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ration Distribution</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    body {
      background: url('https://media.istockphoto.com/id/672724468/photo/interior-of-a-industrial-warehouse-with-drag-chemicals.jpg?s=612x612&w=0&k=20&c=92xyX5mgOMn7gTVUan2bZv9Yy3Ff0fk_BgpD54OfqLs=') no-repeat center center fixed;
      background-size: cover;
    }

    .overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }

    .form-container {
      position: relative;
      z-index: 1;
      max-width: 450px;
      margin: 0 auto;
      padding: 40px;
      background-color: rgba(255, 255, 255, 0.85);
      border-radius: 8px;
      margin-top: 5%;
    }

    .form-container h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .form-container label {
      display: block;
      margin: 12px 0 4px;
      font-weight: bold;
    }

    .form-container input,
    .form-container select {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }

    .form-container button {
      margin-top: 20px;
      width: 100%;
      padding: 10px;
      background-color: #0288d1;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }

    .form-container button:hover {
      background-color: #026fa1;
    }

    .flash-message {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      text-align: center;
    }

    .success { background-color: #d4edda; color: #155724; }
    .danger { background-color: #f8d7da; color: #721c24; }

    /* Back button at top left */
    .back-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 10;
      text-decoration: none;
      color: white;
      background-color: #2c3e50;
      padding: 10px 15px;
      border-radius: 6px;
    }
    .back-btn:hover {
      background-color: #1f2d3a;
    }
  </style>
</head>
<body>
  <div class="overlay"></div>
  <a href="{{ url_for('dashboard_page') }}" class="back-btn">← Back to Dashboard</a>
  <main class="form-container">
    <h1>Ration Distribution Form</h1>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <p class="flash-message {{ category }}">{{ message }}</p>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form action="/ration_distribution" method="post" onsubmit="return validateForm()">
      <label for="beneficiaryId">Beneficiary ID:</label>
      <input type="text" id="beneficiaryId" name="beneficiaryId" required />

      <label for="familyMembers">Family Members:</label>
      <input type="number" id="familyMembers" name="familyMembers" min="1" required oninput="updateQuantity()" />

      <label for="itemType">Ration Item Type:</label>
      <select id="itemType" name="itemType" required onchange="updateQuantity()">
        <option value="">--Select--</option>
        <option value="wheat">Wheat</option>
        <option value="rice">Rice</option>
        <option value="sugar">Sugar</option>
        <option value="kerosene">Kerosene Oil</option>
      </select>

      <label for="quantity">Quantity:</label>
      <input type="number" id="quantity" name="quantity" min="0.1" step="0.1" required />

      <label for="unit">Unit:</label>
      <select id="unit" name="unit" required>
        <option value="">--Select Unit--</option>
        <option value="kg">Kg</option>
        <option value="packet">Packet</option>
        <option value="litre">Litre</option>
        <option value="bottle">Bottle</option>
      </select>

      <label for="pricePerUnit">Price Per Unit (₹):</label>
      <input type="number" id="pricePerUnit" name="pricePerUnit" min="1" step="0.01" required />

      <label for="distribution_date">Distribution Date:</label>
      <input type="date" id="distribution_date" name="distribution_date" required />

      <button type="submit">Distribute Ration</button>
    </form>
  </main>

  <script>
    const distributedThisMonth = {}; // {"B001":"2025-08"}

    const validUnits = {
      wheat: ['kg','packet'],
      rice: ['kg','packet'],
      sugar: ['kg','packet'],
      kerosene: ['litre','bottle']
    };

    const priceTable = {wheat:32, rice:40, sugar:50, kerosene:90};

    function updateQuantity() {
      const item = document.getElementById('itemType').value;
      const familyMembers = parseInt(document.getElementById('familyMembers').value);
      const quantityField = document.getElementById('quantity');

      if(!isNaN(familyMembers) && ['wheat','rice','sugar'].includes(item)) {
        quantityField.value = familyMembers * 5; // auto-calc
      }
    }

    function validateForm() {
      const beneficiaryId = document.getElementById('beneficiaryId').value;
      const familyMembers = parseInt(document.getElementById('familyMembers').value);
      const item = document.getElementById('itemType').value;
      const quantity = parseFloat(document.getElementById('quantity').value);
      const unit = document.getElementById('unit').value;
      const price = parseFloat(document.getElementById('pricePerUnit').value);
      const date = new Date(document.getElementById('distribution_date').value);
      const today = new Date();

      // 1. Ensure distribution only once per month
      const monthKey = date.getFullYear() + '-' + (date.getMonth()+1);
      if(distributedThisMonth[beneficiaryId] === monthKey){
        alert("This beneficiary has already received ration this month!");
        return false;
      }

      // 2. Quantity validation (5 kg per family member)
      if(item !== 'kerosene' && quantity !== familyMembers*5){
        alert(`Quantity for ${item} should be ${familyMembers*5} kg (5kg per person)!`);
        return false;
      }

      // 3. Unit validation
      if(!validUnits[item].includes(unit)){
        alert(`Invalid unit for ${item}! Valid units: ${validUnits[item].join(', ')}`);
        return false;
      }

      // 4. Price validation
      if(price !== priceTable[item]){
        alert(`Invalid price for ${item}! Price should be ${priceTable[item]} per ${unit}`);
        return false;
      }

      // 5. Date validation: can't be in future
      if(date > today){
        alert("Distribution date cannot be in the future!");
        return false;
      }

      distributedThisMonth[beneficiaryId] = monthKey;
      return true;
    }
  </script>
</body>
</html>
